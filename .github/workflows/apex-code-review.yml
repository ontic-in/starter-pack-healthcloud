name: Apex Code Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'development/sf_project/force-app/**/*.cls'
      - 'development/sf_project/force-app/**/*.trigger'
      - '.github/workflows/apex-code-review.yml'

jobs:
  apex-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Download and setup PMD
        run: |
          cd $HOME
          wget https://github.com/pmd/pmd/releases/download/pmd_releases%2F7.17.0/pmd-dist-7.17.0-bin.zip
          unzip pmd-dist-7.17.0-bin.zip
          echo "$HOME/pmd-bin-7.17.0/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: npm install

      - name: Install sf_project dependencies
        working-directory: development/sf_project
        run: npm ci

      - name: Run Apex Code Review
        id: review
        run: |
          set +e  # Don't exit on error
          set -o pipefail  # Capture exit code from bash, not tee
          bash scripts/ci-apex-review.sh 2>&1 | tee apex-review.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "Apex code review exit code: $EXIT_CODE"
          exit 0  # Always succeed so we can check exit code in final step
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload review logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apex-review-logs-${{ github.run_id }}
          path: apex-review.log
          retention-days: 30

      - name: Final status check
        if: steps.review.outputs.exit_code != '0'
        run: |
          echo "::error::Apex code review failed - production blockers detected"
          exit 1
