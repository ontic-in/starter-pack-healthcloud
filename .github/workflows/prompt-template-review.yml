name: Prompt Template Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'development/prompt_development_and_testing/prompts/**/*.md'
      - 'development/prompt_development_and_testing/tests/**/*.ts'
      - '.github/workflows/prompt-template-review.yml'

jobs:
  prompt-review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run Prompt Template Review
        id: review
        run: |
          set +e  # Don't exit on error
          set -o pipefail  # Capture exit code from bash, not tee
          bash scripts/ci-prompt-review.sh 2>&1 | tee prompt-review.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "Prompt template review exit code: $EXIT_CODE"
          exit 0  # Always succeed so we can check exit code in final step
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload review logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: prompt-review-logs-${{ github.run_id }}
          path: prompt-review.log
          retention-days: 30

      - name: Final status check
        if: steps.review.outputs.exit_code != '0'
        run: |
          echo "::error::Prompt template review failed - specification alignment or critical violations detected"
          exit 1
